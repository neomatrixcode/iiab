name: GitHub Action

on: [push]

jobs:
  Explore-GitHub-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ github.workspace }}
      - name: Install VPN
        run: |
          # As 'bash -x' is ignored above, when pipe has already launched bash
          set -x

          echo "root:g0adm1n" > pass
          sudo chpasswd < pass

          sudo apt-get update
          sudo apt-get -y install openssh-server ncat nmap openvpn

          # /etc/ssh/sshd_config.d/60-cloudimg-settings.conf sometimes contains
          # "PasswordAuthentication no" (due to Multipass / cloud-init on Ubuntu 22.10 ?)
          sudo mv /etc/ssh/sshd_config.d/* ~

          if grep -q '^PermitRootLogin[[:blank:]]' /etc/ssh/sshd_config ; then
              sudo sed -i 's/^PermitRootLogin[[:blank:]].*/PermitRootLogin yes/' /etc/ssh/sshd_config
          else
              sudo echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config
          fi

          if grep -q '^PasswordAuthentication[[:blank:]]' /etc/ssh/sshd_config ; then
              sudo sed -i 's/^PasswordAuthentication[[:blank:]].*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          else
              sudo echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config
          fi

          sudo systemctl restart ssh


          mkdir -p /etc/openvpn/keys /etc/openvpn/scripts

          cd /etc/openvpn/keys/
          wget https://raw.githubusercontent.com/iiab/iiab/master/roles/openvpn/templates/ca.crt -O ca.crt
          wget https://raw.githubusercontent.com/iiab/iiab/master/roles/openvpn/templates/client1.crt -O client1.crt
          chmod 644 ca.crt client1.crt
          wget https://raw.githubusercontent.com/iiab/iiab/master/roles/openvpn/templates/client1.key -O client1.key
          chmod 600 client1.key

          cd /etc/openvpn/scripts/
          wget https://raw.githubusercontent.com/iiab/iiab/master/roles/openvpn/templates/announce -O announce
          wget https://raw.githubusercontent.com/iiab/iiab/master/roles/openvpn/templates/announcer -O announcer
          wget https://raw.githubusercontent.com/iiab/iiab/master/roles/openvpn/templates/silence -O silence
          chmod 755 announce announcer silence

          cd /etc/openvpn/
          wget https://iiab.io/packages/xscenet.conf -O xscenet.conf
          chmod 644 xscenet.conf

          systemctl daemon-reload
          systemctl restart openvpn

          # Nice idea, but OpenVPN IP address is usually not quite ready!
          # hostname -I
      - run: echo "üçè This job's status is ${{ job.status }}."